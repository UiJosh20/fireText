<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FireText | Home</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  </head>
  <body>

    <main class="main2">
      <div>
        <h2>FIRETEXT</h2>
      </div>
      <div id="display"></div>
    </main>
    <section class="containerheight d-flex">
      <main class="main1  w-25 p-2">
        <div class=" w-100 chatgrid p-3 border-bottom">
          hello world
        </div>
        <div class=" w-100 chatgrid p-3 border-bottom">
          hello world
        </div>
      </main>
      <main>

        <div class="bg-white w100 p-3">
          <input type="text">
          <button class="w-25 ms-2">send</button>
        </div>
      </main>
    </section>










    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

      import {
        getDatabase,
        ref,
        set,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

      import {
        getStorage,
        ref as storageRef,
        uploadBytesResumable,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDrYE8XNu3iODjvoggJzoHVhUAFGif9Yn4",
        authDomain: "fireflix-89f3e.firebaseapp.com",
        projectId: "fireflix-89f3e",
        storageBucket: "fireflix-89f3e.appspot.com",
        messagingSenderId: "527315772858",
        appId: "1:527315772858:web:964476cdc61cd24ac3a983",
        measurementId: "G-EF2W2QN8Y8",
        databaseURL: "https://fireflix-89f3e-default-rtdb.firebaseio.com",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);
      const storage = getStorage(app);
      let startPoint = 0;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log(user);
          let Cname = user.displayName;
          let maily = user.email;
          let dispImg = user.photoURL;

          if (Cname == null && dispImg == null) {
            display.innerHTML = `
          <h3>${maily}</h3>
          <button onclick="googleSignOut()">log out</button>
            
            `;
          } else {
            display.innerHTML = `
            <h3>${Cname}</h3>
            <img src=${dispImg} style="border-radius: 100%;"  class="minus" title="profile picture"/>
            <img src="images/logout.png" alt="sign-out icon" width="35" onclick="googleSignOut()" title="sign out" class="signlogo">
  
          `;
          }
        } else {
          // window.location.href = "signin.html";
        }
      });

      const googleSignOut = () => {
        signOut(auth)
          .then(() => {
            console.log("out with you");
          })
          .catch((error) => {
            console.log(error);
          });
      };

      window.googleSignOut = googleSignOut;

      const submitData = () => {
        let titleH = titleHome.value;
        let releaseDate = release.value;
        let date = new Date().toLocaleDateString();
        let time = new Date().toLocaleTimeString();
        onAuthStateChanged(auth, (user) => {
          let userName = user.displayName;
          if (titleH !== "" && releaseDate !== "") {
            titleHome.value = "";
            release.value = "";
            let todoObj = {
              userName,
              titleH,
              file: myFile.files[0].name,
              releaseDate,
              date,
              time,
            };
            let dbRef = ref(database, `savedData/${startPoint}`);
            set(dbRef, todoObj);

            let filename = myFile.files[0].name;
            let uploadedFile = myFile.files[0];
            let stref = storageRef(
              storage,
              `Uploaded/${todoObj.userName}/${filename}`
            );
            let doneStoring = uploadBytesResumable(storageRef, uploadedFile);
            doneStoring.on("state_changed", (snapshot) => {
              let progress = snapshot.bytesTransferred;
              let total = snapshot.totalBytes;
              const showProgress = ((progress / total) * 100).toFixed(2);
              console.log(showProgress);
            });
          }
        });
      };

      window.submitData = submitData;

      let sdbRef = ref(database, "savedData");
      onValue(sdbRef, (snapshot) => {
        const data = snapshot.val();
        console.log(data.length);

        if (data.length > 0) {
          startPoint = data.length;
        } else {
          startPoint = 0;
        }

        display2.innerHTML = "";

        data.map((item) => {
          document.getElementById("display2").innerHTML += `
        <div style="color:white;">
          <h4>${item.titleH}</h4>
          <p>${item.releaseDate}</p>
        </div>
      `;
        });
        console.log(data);
      });
    </script>

  </body>
</html>
